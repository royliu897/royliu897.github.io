<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roy R. Liu | Portfolio</title>
    <style>
        :root { --bg: #242b20; --accent: #ffffff; }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Helvetica Neue', Helvetica, sans-serif; }
        canvas { display: block; cursor: crosshair; }
        
        /* UI Layer */
        #header {
            position: absolute; top: 40px; width: 100%; text-align: center;
            color: var(--accent); pointer-events: none; z-index: 100;
            text-shadow: 0 4px 12px rgba(0,0,0,0.5); transition: opacity 0.5s;
        }

        /* Project Page Transition Overlay */
        #project-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; color: white; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; clip-path: circle(0% at 50% 50%);
            transition: clip-path 0.8s cubic-bezier(0.86, 0, 0.07, 1);
        }
        #project-page.active { display: flex; clip-path: circle(150% at 50% 50%); }
        .back-btn { margin-top: 20px; padding: 10px 20px; cursor: pointer; background: white; color: black; border: none; font-weight: bold; }
        
        /* Loading Screen */
        #loader {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; align-items: center; justify-content: center;
            color: white; z-index: 2000;
        }
    </style>
</head>
<body>

<div id="loader">Loading Environment...</div>

<div id="header">
    <h1 id="title-text">Welcome to my webpage, click on something.</h1>
</div>

<div id="project-page">
    <h1 id="project-title">Project Name</h1>
    <p>Details about this experience will go here.</p>
    <button class="back-btn" onclick="closeProject()">‚Üê Back to the Forest</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- TECHNICAL CONFIG ---
const DOG_W = 32, DOG_H = 40;
const LEASH_RADIUS = 150;
let isProjectOpen = false;

const assets = {
    dog: 'assets/dog.png', fallLeaf: 'assets/fall_leaf.png', springLeaf: 'assets/spring_leaf.png',
    car: 'assets/car.png', gamma: 'assets/gamma.png', racket: 'assets/racket.png', stock: 'assets/stock.png'
};
const assetImgs = {};

const projectIcons = [
    { id: 'car', x: 300, y: 450, rot: Math.random()*Math.PI, label: 'Longhorn Racing' },
    { id: 'gamma', x: 850, y: 350, rot: Math.random()*Math.PI, label: 'Research Project' },
    { id: 'racket', x: 500, y: 750, rot: Math.random()*Math.PI, label: 'Tennis' },
    { id: 'stock', x: 1100, y: 600, rot: Math.random()*Math.PI, label: 'Finance Modeling' }
];

let leaves = [], particles = [], mouse = { x: 0, y: 0 };
let dog = { x: 100, y: 100, vx: 0, vy: 0, row: 2, col: 0, forceSit: false };

// --- SMART PRELOADING ---
async function preload() {
    const promises = Object.keys(assets).map(key => {
        return new Promise(resolve => {
            const img = new Image();
            img.src = assets[key];
            img.onload = () => { assetImgs[key] = img; resolve(); };
        });
    });
    await Promise.all(promises);
    document.getElementById('loader').style.display = 'none';
    init();
}

function init() {
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    window.dispatchEvent(new Event('resize'));
    
    window.addEventListener('mousemove', e => { 
        if(!isProjectOpen) { mouse.x = e.clientX; mouse.y = e.clientY; }
    });

    window.addEventListener('mousedown', e => {
        if(isProjectOpen) return;

        // 1. Check if we clicked a revealed icon to enter project
        for (let icon of projectIcons) {
            let d = Math.hypot(e.clientX - icon.x, e.clientY - icon.y);
            if (d < 60) {
                openProject(icon, e.clientX, e.clientY);
                return;
            }
        }

        // 2. Trigger the "FLOOMPH"
        dog.forceSit = true;
        triggerShockwave(e.clientX, e.clientY);
        setTimeout(() => { dog.forceSit = false; }, 1000);
    });

    // Generate 600 physics-enabled leaves
    for(let i=0; i<600; i++) {
        leaves.push({
            x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight,
            rot: Math.random()*Math.PI*2, type: Math.random()>0.5?'fallLeaf':'springLeaf',
            frame: Math.floor(Math.random()*5), size: 45+Math.random()*30,
            vx: 0, vy: 0, vr: 0
        });
    }
    requestAnimationFrame(loop);
}

function triggerShockwave(cx, cy) {
    leaves.forEach(l => {
        let d = Math.hypot(l.x - cx, l.y - cy);
        if (d < 220) {
            let angle = Math.atan2(l.y - cy, l.x - cx);
            let force = (220 - d) * 0.15;
            l.vx = Math.cos(angle) * force;
            l.vy = Math.sin(angle) * force;
            l.vr = (Math.random()-0.5) * 0.5;
        }
    });
    // Particle Burst
    for(let i=0; i<30; i++) {
        particles.push({
            x: cx, y: cy, vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20 - 5,
            life: 1.0, color: Math.random()>0.5?'#d35400':'#27ae60', rot: Math.random()*5
        });
    }
}

function openProject(icon, x, y) {
    isProjectOpen = true;
    const page = document.getElementById('project-page');
    document.getElementById('project-title').innerText = icon.label;
    page.style.clipPath = `circle(0% at ${x}px ${y}px)`;
    page.style.display = 'flex';
    setTimeout(() => { page.classList.add('active'); }, 10);
    document.getElementById('header').style.opacity = '0';
}

function closeProject() {
    const page = document.getElementById('project-page');
    page.classList.remove('active');
    setTimeout(() => { 
        page.style.display = 'none'; 
        isProjectOpen = false;
        document.getElementById('header').style.opacity = '1';
    }, 800);
}

function loop() {
    ctx.fillStyle = '#242b20';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Dog Logic
    let dx = mouse.x - dog.x, dy = mouse.y - dog.y;
    let dist = Math.hypot(dx, dy);
    let oldX = dog.x;

    if (!dog.forceSit && dist > LEASH_RADIUS) {
        dog.x += dx * 0.05; dog.y += dy * 0.05;
    }
    let vx = dog.x - oldX;

    // Sprite Pick
    if (dog.forceSit || Math.abs(vx) < 0.2) {
        dog.row = 2; dog.col = dog.forceSit ? (Math.floor(Date.now()/200)%2) : 0;
    } else {
        dog.row = vx > 0 ? 6 : 7;
        dog.col = Math.floor(Date.now()/100)%4;
    }

    // Combined Y-Sort Render
    let items = [
        ...projectIcons.map(i => ({ type:'icon', obj:i, y:i.y })),
        ...leaves.map(l => ({ type:'leaf', obj:l, y:l.y })),
        { type:'dog', obj:dog, y:dog.y }
    ].sort((a,b) => a.y - b.y);

    items.forEach(item => {
        if (item.type === 'leaf') {
            let l = item.obj;
            // Dog proximity push
            if (Math.hypot(l.x - dog.x, l.y - dog.y) < 60) {
                l.vx = (l.x-dog.x)*0.15; l.vy = (l.y-dog.y)*0.15; l.vr = 0.1;
            }
            l.x += l.vx; l.y += l.vy; l.rot += l.vr;
            l.vx *= 0.92; l.vy *= 0.92; l.vr *= 0.92; // Friction

            ctx.save();
            ctx.translate(l.x, l.y); ctx.rotate(l.rot);
            ctx.drawImage(assetImgs[l.type], l.frame*16, 0, 16, 16, -l.size/2, -l.size/2, l.size, l.size);
            ctx.restore();
        } else if (item.type === 'icon') {
            let i = item.obj;
            ctx.save();
            ctx.translate(i.x, i.y); ctx.rotate(i.rot);
            ctx.drawImage(assetImgs[i.id], -60, -60, 120, 120);
            ctx.restore();
            ctx.fillStyle = "white"; ctx.font = "bold 16px sans-serif"; ctx.textAlign = "center";
            ctx.fillText(i.label, i.x, i.y + 85);
        } else if (item.type === 'dog') {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath(); ctx.ellipse(dog.x, dog.y+35, 45, 15, 0,0,Math.PI*2); ctx.fill();
            ctx.drawImage(assetImgs.dog, dog.col*DOG_W, dog.row*DOG_H, DOG_W, DOG_H, dog.x-65, dog.y-85, 130, 160);
        }
    });

    particles.forEach((p, idx) => {
        p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.02;
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
        ctx.fillRect(p.x, p.y, 15, 15);
        if (p.life <= 0) particles.splice(idx, 1);
    });
    ctx.globalAlpha = 1.0;

    requestAnimationFrame(loop);
}

preload();
</script>
</body>
</html>
