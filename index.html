const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- DIMENSIONS FROM YOUR DATA ---
const DOG_W = 32; 
const DOG_H = 40;
const LEAF_SIZE = 16;

let mouse = { x: window.innerWidth/2, y: window.innerHeight/2 };
let dog = { x: 100, y: 100, vx: 0, vy: 0, frame: 0, lastDir: 'down' };
let leaves = [];
let particles = [];

const assets = {
    dog: { src: 'assets/dog.png', img: new Image(), loaded: false },
    fallLeaf: { src: 'assets/fall_leaf.png', img: new Image(), loaded: false },
    springLeaf: { src: 'assets/spring_leaf.png', img: new Image(), loaded: false },
    car: { src: 'assets/car.png', img: new Image(), loaded: false },
    gamma: { src: 'assets/gamma.png', img: new Image(), loaded: false },
    racket: { src: 'assets/racket.png', img: new Image(), loaded: false },
    stock: { src: 'assets/stock.png', img: new Image(), loaded: false }
};

const projectIcons = [
    { id: 'car', x: 200, y: 300, revealed: false, label: 'Longhorn Racing' },
    { id: 'gamma', x: 600, y: 200, revealed: false, label: 'Research' },
    { id: 'racket', x: 300, y: 600, revealed: false, label: 'Tennis' },
    { id: 'stock', x: 800, y: 400, revealed: false, label: 'Finance Modeling' }
];

function init() {
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    window.dispatchEvent(new Event('resize'));

    window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    window.addEventListener('mousedown', () => {
        projectIcons.forEach(icon => {
            let d = Math.hypot(mouse.x - icon.x, mouse.y - icon.y);
            if (d < 80) {
                icon.revealed = true;
                burstLeaves(icon.x, icon.y);
            }
        });
    });

    Object.keys(assets).forEach(key => {
        assets[key].img.onload = () => { assets[key].loaded = true; };
        assets[key].img.src = assets[key].src;
    });

    for(let i=0; i<200; i++) {
        leaves.push({
            x: Math.random()*window.innerWidth, 
            y: Math.random()*window.innerHeight,
            rot: Math.random()*Math.PI*2,
            type: Math.random() > 0.5 ? 'fallLeaf' : 'springLeaf',
            frame: Math.floor(Math.random()*5) // Picks 1 of the 5 shapes
        });
    }
    requestAnimationFrame(gameLoop);
}

function burstLeaves(x, y) {
    for(let i=0; i<20; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random()-0.5)*12,
            vy: (Math.random()-0.5)*12 - 4,
            life: 1.0,
            color: Math.random() > 0.5 ? '#e67e22' : '#27ae60'
        });
    }
}

function gameLoop() {
    ctx.fillStyle = '#3d4a35'; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 1. Draw Buried Icons
    projectIcons.forEach(icon => {
        if (assets[icon.id].loaded) {
            ctx.globalAlpha = icon.revealed ? 1.0 : 0.15;
            ctx.drawImage(assets[icon.id].img, icon.x - 40, icon.y - 40, 80, 80);
            if (icon.revealed) {
                ctx.fillStyle = "white";
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(icon.label, icon.x, icon.y + 60);
            }
        }
    });
    ctx.globalAlpha = 1.0;

    // 2. Dog Physics & Animation Logic
    let oldX = dog.x;
    let oldY = dog.y;
    dog.x += (mouse.x - dog.x) * 0.06;
    dog.y += (mouse.y - dog.y) * 0.06;
    let vx = dog.x - oldX;
    let vy = dog.y - oldY;
    let speed = Math.hypot(vx, vy);

    // Determine Sprite Row
    let row = 0; // Default: Standing facing me
    let col = Math.floor(Date.now() / 150) % 2; // Simple 2-frame anim

    if (speed > 0.5) {
        if (Math.abs(vx) > Math.abs(vy)) {
            row = vx > 0 ? 6 : 7; // Walking Right/Left rows
        } else {
            row = vy > 0 ? 4 : 5; // Walking Toward/Away rows
        }
        col = Math.floor(Date.now() / 100) % 4; // 4-frame walk cycle
    } else {
        row = 2; // Sitting facing me
    }

    // 3. Draw Leaves (Trudging)
    leaves.forEach(l => {
        let dist = Math.hypot(l.x - dog.x, l.y - dog.y);
        if (dist < 40) {
            l.x += vx * 1.2;
            l.y += vy * 1.2;
            l.rot += 0.1;
        }
        if (assets[l.type].loaded) {
            ctx.save();
            ctx.translate(l.x, l.y);
            ctx.rotate(l.rot);
            // Draw one of the 5 leaves from the 80x16 sheet
            ctx.drawImage(assets[l.type].img, l.frame * 16, 0, 16, 16, -8, -8, 16, 16);
            ctx.restore();
        }
    });

    // 4. Draw Dog
    if (assets.dog.loaded) {
        ctx.drawImage(assets.dog.img, col * DOG_W, row * DOG_H, DOG_W, DOG_H, dog.x-DOG_W, dog.y-DOG_H, DOG_W*2, DOG_H*2);
    }

    // 5. Draw Dig Particles
    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.life -= 0.02;
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life;
        ctx.fillRect(p.x, p.y, 6, 6);
        if (p.life <= 0) particles.splice(i, 1);
    });
    ctx.globalAlpha = 1.0;

    requestAnimationFrame(gameLoop);
}

init();
